pipeline {
    agent {
        node {
            label 'slave'
        }
    }
    tools {
        git 'git'
    }
    parameters {
        string description: 'Organization name of the node', name: 'org_name', trim: true
        string description: 'Environment (dev | test | prod)', name: 'env', trim: true
        choice choices: ['setup', 'cleanup'], description: 'Choose setup/clean vault instance', name: 'action'
        string description: 'AWS region', name: 'aws_region', trim: true
        string description: 'Name of the blockchain cluster(EKS)', name: 'blk_cluster_name', trim: true
        string description: 'Registry', name: 'registry', trim: true
        booleanParam description: 'OrdererOrg status', defaultValue: false, name: 'ordererorg'
        string description: 'OrdererOrg name', name: 'ordererorg_name', trim: true
        string description: 'Internal Domain', name: 'internal_domain', trim: true
        }
    stages{
        stage('Vault-Setup'){
            when {
                expression { "${params.action}" == "setup" }
            }
            steps {
                wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
                    ansibleTower(
                        towerServer: 'AWX',
                        towerCredentialsId: 'AWX',
                        templateType: 'job',
                        jobTemplate: "openidl-vault-setup",
                        jobType: "run",
                        towerLogLevel: 'full',
                        removeColor: false,
                        async: false,
                        importTowerLogs: true,
                        extraVars: """---
                        aws_region: '${params.aws_region}'
                        blk_cluster_name: '${params.blk_cluster_name}'
                        registry: '${params.registry}'
                        env: '${params.env}'
                        internal_domain: '${params.internal_domain}'
                        network:
                            org_name: '${params.org_name}'
                            ordererorg_name: '${params.ordererorg_name}'
                            ordererorg: '${params.ordererorg}'
                        """
                        )
                }
            }
        }
        stage('Vault-Cleanup'){
            when {
                expression { "${params.action}" == "cleanup" }
            }
            steps {
                wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
                    ansibleTower(
                        towerServer: 'AWX',
                        towerCredentialsId: 'AWX',
                        templateType: 'job',
                        jobTemplate: "openidl-vault-cleanup",
                        jobType: "run",
                        towerLogLevel: 'full',
                        importTowerLogs: true,
                        removeColor: false,
                        async: false,
                        extraVars: """---
                        aws_region: '${params.aws_region}'
                        blk_cluster_name: '${params.blk_cluster_name}'
                        env: '${params.env}'
                        network:
                            org_name: '${params.org_name}'
                            ordererorg_name: '${params.ordererorg_name}'
                            ordererorg: '${params.ordererorg}'
                        """
                        )
                }
            }
        }
    }
    post {
        success {
            echo "The vault action is successful"

        }
        failure {
            echo "The vault action is failed, Please investigate"

        }
    }
}

